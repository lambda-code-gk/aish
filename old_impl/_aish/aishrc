#!/bin/bash

#set -x


if [ -z "$AISH_HOME" ]; then
  export AISH_HOME="$HOME/.aish"
fi

if [ -e "$HOME/.apikey" ]; then
  . $HOME/.apikey
fi

. $AISH_HOME/functions

bind -x '"\C-l": aish_clear'

export PS1_ORG=$PS1
export PROMPT_COMMAND='PS1="(aish:$(detail.aish_calc_message_size))$PS1_ORG"'
export AISH_PID=$PPID
export AISH_MAX_SEND_MESSAGE=50


# completion for ai subcommands
function _ai_subcommand_completions
{
    local cur prev opts
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"

    if [[ ${COMP_CWORD} -eq 1 ]]; then
        local task_dir="${AISH_HOME:-$HOME/.aish}/task.d"
        [ ! -d "$task_dir" ] && return 0

        # 1. Directory tasks (top-level only)
        local dirs=$(find "$task_dir" -mindepth 1 -maxdepth 1 -type d -printf '%f\n')
        # 2. Script tasks (hierarchical, strip .sh)
        local scripts=$(find "$task_dir" -type f -name "*.sh" -printf '%P\n' | sed 's/\.sh$//')
        # 3. Extensionless files (hierarchical)
        local plain=$(find "$task_dir" -type f ! -name "*.*" -printf '%P\n')

        opts=$(echo -e "${dirs}\n${scripts}\n${plain}" | grep -vE "(^|/)execute$" | sort -u)
        COMPREPLY=( $(compgen -W "${opts}" -- "${cur}") )
        return 0
    fi
}

complete -F _ai_subcommand_completions ai

# completion for aish subcommands
function _aish_subcommand_completions
{
    local cur prev opts
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"

    if [[ ${COMP_CWORD} -eq 1 ]]; then
        opts="resume sessions "
        opts+=$(declare -f | grep -oP '^aish_\K\w+')
        opts+=" $(compgen -c | grep -oP '^aish_\K\w+')"
        COMPREPLY=( $(compgen -W "${opts}" -- ${cur}) )
        return 0
    fi

    if [[ ${COMP_CWORD} -eq 2 && "${COMP_WORDS[1]}" == "resume" ]]; then
        opts=$(ls -1 $AISH_HOME/sessions 2>/dev/null | grep -v "latest")
        COMPREPLY=( $(compgen -W "${opts}" -- ${cur}) )
        return 0
    fi
}

complete -F _aish_subcommand_completions aish
