#!/usr/bin/env bash


. $AISH_HOME/functions

#set -x

# エラーハンドリングとログライブラリを読み込む
. "$AISH_HOME/lib/error_handler.sh"
. "$AISH_HOME/lib/logger.sh"

# エラーハンドリングとロガーの初期化
error_handler_init
logger_init

# セッション管理ライブラリを読み込む
. "$AISH_HOME/lib/session_manager.sh"

# タスク管理ライブラリを読み込む
. "$AISH_HOME/lib/task.sh"

# セッション管理を初期化（ロックチェックと一時セッション作成）
session_manager_init

function cleanup_on_exit()
{
  # セッション管理のクリーンアップ処理を呼び出す
  session_manager_cleanup
  echo
  exit $?
}
trap cleanup_on_exit EXIT INT TERM

APP_DIR=$(dirname "$(readlink -f "$0")")

# '+' disables getopt's argument reordering.
PARSED_OPTIONS=$(getopt -o +hTp:c --long help,skip-security-check,no-thought,profile:,pro,cheap,local,continue,preview-query -n "$(basename "$0")" -- "$@")

eval set -- "$PARSED_OPTIONS"
while true; do
  case "$1" in
    --skip-security-check)
      skip_security_check="true"
      shift
      ;;
    -T|--no-thought)
      export AISH_HIDE_THOUGHT="true"
      shift
      ;;
    -p|--profile)
      export AISH_PROFILE="$2"
      shift 2
      ;;
    --pro)
      export AISH_PROFILE="pro"
      shift
      ;;
    --cheap)
      export AISH_PROFILE="cheap"
      shift
      ;;
    --local)
      export AISH_PROFILE="local"
      shift
      ;;
    -c|--continue)
      export AISH_CONTINUE="true"
      shift
      ;;
    --preview-query)
      export AISH_PREVIEW_QUERY="true"
      shift
      ;;
    -h|--help)
      help="true"
      shift
      ;;
    --) shift; break ;;
    *) error_error "Unknown option: $1" '{"component": "ai"}'; exit 1 ;;
  esac
done

# Load profile if specified or default
if [ -z "$AISH_PROFILE" ]; then
  export AISH_PROFILE="default"
fi

if [ -f "$AISH_HOME/profiles/$AISH_PROFILE.sh" ]; then
  . "$AISH_HOME/profiles/$AISH_PROFILE.sh"
fi


task_arg="$1"
task_path=""

if [ -n "$task_arg" ]; then
  # Security check: prevent directory traversal
  if ! task_validate_name "$task_arg"; then
    exit 1
  fi

  # Try to resolve task path
  task_path=$(task_resolve_path "$task_arg")
  if [ -n "$task_path" ]; then
    shift
  fi
fi

if [ -z "$task_path" ]; then
  # Try to find default task
  task_path=$(task_find_default)
fi

if [ -z "$task_path" ]; then
   error_error "Default task not found in $AISH_HOME/task.d/" '{"component": "ai"}'
   exit 1
fi

if [[ "$help" == "true" ]];
then
  echo "Usage: $(basename "$0") [options] [task] [message]"
  echo "Options:"
  printf "  %s\t%s\n" "-h, --help" "Show this help message"
  printf "  %s\t%s\n" "-T, --no-thought" "Hide agent's thinking process"
  printf "  %s\t%s\n" "-c, --continue" "Continue from last interrupted session"
  printf "  %s\t%s\n" "--preview-query" "Preview the query and system instruction without sending"
  printf "  %s\t%s\n" "--skip-security-check" "Skip security checks"
  echo
  echo "Tasks:"
  task_list_all
  exit 0
fi

task_execute "$task_path"
