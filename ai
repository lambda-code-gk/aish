#!/usr/bin/env bash


. $AISH_HOME/functions

#set -xe

# エラーハンドリングとログライブラリを読み込む
. "$AISH_HOME/lib/error_handler.sh"
. "$AISH_HOME/lib/logger.sh"

# エラーハンドリングとロガーの初期化
error_handler_init
logger_init

# セッション管理ライブラリを読み込む
. "$AISH_HOME/lib/session_manager.sh"

# セッション管理を初期化（ロックチェックと一時セッション作成）
session_manager_init

function cleanup_on_exit()
{
  # セッション管理のクリーンアップ処理を呼び出す
  session_manager_cleanup
  echo
  exit $?
}
trap cleanup_on_exit EXIT INT TERM

APP_DIR=$(dirname "$(readlink -f "$0")")

# '+' disables getopt's argument reordering.
PARSED_OPTIONS=$(getopt -o +hTp:c --long help,skip-security-check,no-thought,profile:,pro,cheap,local,continue,preview-query -n "$(basename "$0")" -- "$@")

eval set -- "$PARSED_OPTIONS"
while true; do
  case "$1" in
    --skip-security-check)
      skip_security_check="true"
      shift
      ;;
    -T|--no-thought)
      export AISH_HIDE_THOUGHT="true"
      shift
      ;;
    -p|--profile)
      export AISH_PROFILE="$2"
      shift 2
      ;;
    --pro)
      export AISH_PROFILE="pro"
      shift
      ;;
    --cheap)
      export AISH_PROFILE="cheap"
      shift
      ;;
    --local)
      export AISH_PROFILE="local"
      shift
      ;;
    -c|--continue)
      export AISH_CONTINUE="true"
      shift
      ;;
    --preview-query)
      export AISH_PREVIEW_QUERY="true"
      shift
      ;;
    -h|--help)
      help="true"
      shift
      ;;
    --) shift; break ;;
    *) error_error "Unknown option: $1" '{"component": "ai"}'; exit 1 ;;
  esac
done

# Load profile if specified or default
if [ -z "$AISH_PROFILE" ]; then
  export AISH_PROFILE="default"
fi

if [ -f "$AISH_HOME/profiles/$AISH_PROFILE.sh" ]; then
  . "$AISH_HOME/profiles/$AISH_PROFILE.sh"
fi


task_arg="$1"
task_path=""

if [ -n "$task_arg" ]; then
  # Security check: prevent directory traversal
  if [[ "$task_arg" == /* ]] || [[ "$task_arg" == *..* ]]; then
    error_error "Invalid task name: $task_arg" '{"component": "ai"}'
    exit 1
  fi

  # 1. Directory (legacy)
  if [ -d "$AISH_HOME/task.d/$task_arg" ] && [ -f "$AISH_HOME/task.d/$task_arg/execute" ]; then
    task_path="$AISH_HOME/task.d/$task_arg"
    shift
  # 2. File exactly as specified
  elif [ -f "$AISH_HOME/task.d/$task_arg" ]; then
    task_path="$AISH_HOME/task.d/$task_arg"
    shift
  # 3. File with .sh suffix
  elif [ -f "$AISH_HOME/task.d/$task_arg.sh" ]; then
    task_path="$AISH_HOME/task.d/$task_arg.sh"
    shift
  fi
fi

if [ -z "$task_path" ]; then
  # Try to find default task
  if [ -d "$AISH_HOME/task.d/default" ] && [ -f "$AISH_HOME/task.d/default/execute" ]; then
    task_path="$AISH_HOME/task.d/default"
  elif [ -f "$AISH_HOME/task.d/default.sh" ]; then
    task_path="$AISH_HOME/task.d/default.sh"
  elif [ -f "$AISH_HOME/task.d/default" ]; then
    task_path="$AISH_HOME/task.d/default"
  fi
fi

if [ -z "$task_path" ]; then
   error_error "Default task not found in $AISH_HOME/task.d/" '{"component": "ai"}'
   exit 1
fi

if [[ "$help" == "true" ]];
then
  echo "Usage: $(basename "$0") [options] [task] [message]"
  echo "Options:"
  printf "  %s\t%s\n" "-h, --help" "Show this help message"
  printf "  %s\t%s\n" "-T, --no-thought" "Hide agent's thinking process"
  printf "  %s\t%s\n" "-c, --continue" "Continue from last interrupted session"
  printf "  %s\t%s\n" "--preview-query" "Preview the query and system instruction without sending"
  printf "  %s\t%s\n" "--skip-security-check" "Skip security checks"
  echo
  echo "Tasks:"
  (
    # Directory tasks
    find "$AISH_HOME/task.d" -mindepth 1 -maxdepth 1 -type d | while read -r task_dir; do
      task_name=$(basename "$task_dir")
      if [ -f "$task_dir/conf" ] && [ -f "$task_dir/execute" ]; then
        desc=$( ( . "$task_dir/conf"; echo "$description" ) )
        echo -e "  $task_name\t$desc"
      fi
    done

    # Script tasks (.sh)
    find "$AISH_HOME/task.d" -type f -name "*.sh" | while read -r script_file; do
      rel_path=${script_file#$AISH_HOME/task.d/}
      task_name=${rel_path%.sh}
      desc=$(grep -m 1 "^# Description:" "$script_file" | sed 's/^# Description:[[:space:]]*//')
      echo -e "  $task_name\t$desc"
    done

    # Plain files (without extension)
    find "$AISH_HOME/task.d" -type f ! -name "*.*" | while read -r plain_file; do
      rel_path=${plain_file#$AISH_HOME/task.d/}
      [ "$(basename "$rel_path")" == "execute" ] && continue
      [ "$(basename "$rel_path")" == "conf" ] && continue
      task_name="$rel_path"
      desc=$(grep -m 1 "^# Description:" "$plain_file" | sed 's/^# Description:[[:space:]]*//')
      echo -e "  $task_name\t$desc"
    done
  ) | sort -u | column -t -s $'\t'
  exit 0
fi

if [ -d "$task_path" ]; then
  . "$task_path/conf"
  . "$task_path/execute"
else
  # If it's a file, we just source it.
  # We used to source default/conf here, but that's legacy behavior.
  # For backward compatibility, check if it exists.
  if [ -f "$AISH_HOME/task.d/default/conf" ]; then
    . "$AISH_HOME/task.d/default/conf"
  fi
  . "$task_path"
fi
