#!/usr/bin/env bash


# Function to display usage
usage() {
    echo "Usage: $0 [-h] [-d directory] <command> [args...]"
    echo "  -h            Display this help message."
    echo "  -d directory  Specify a directory for the session."
    echo "  <command>     Command to execute (e.g., ls, start, stop)."
    echo "  [args...]     Arguments for the command."
    echo ""
    echo "Available commands:"
    echo "  resume [id]            Resume a session (default: latest)."
    echo "  sessions               List available sessions."
    echo "  rollout                Write the terminal log to the part file."
    echo "  clear                  Clear the console and part files."
    echo "  ls                     List the part files."
    echo "  rm_last                Remove the last part file."
    echo "  memory                 Manage memories (--list, --show <id>, --revoke <id>)."
    echo "  models                 Manage models (--provider, --unsupported, --available)."
    exit 1
}

# Parse command-line options
while getopts ":hd:" opt; do
    case ${opt} in
        h )
            usage
            ;;
        d )
            session=$OPTARG
            ;;
        \? )
            echo "Invalid option: -$OPTARG" 1>&2
            usage
            ;;
        : )
            echo "Invalid option: -$OPTARG requires an argument" 1>&2
            usage
            ;;
    esac
done
shift $((OPTIND -1))

AISH_HOME="${AISH_HOME:-$HOME/.aish}"
SESSIONS_DIR="$AISH_HOME/sessions"
export AISH_RENDER_BIN="${AISH_RENDER_BIN:-$AISH_HOME/bin/aish-render}"
export AISH_CAPTURE_BIN="${AISH_CAPTURE_BIN:-$AISH_HOME/bin/aish-capture}"

# Handle the command
command=$1

if [ "$command" = "sessions" ]; then
    ls -1 "$SESSIONS_DIR" 2>/dev/null | grep -v "latest" | sort -r
    if [ -d $AISH_SESSION ]; then
    	echo "current: $(basename $AISH_SESSION)"
    fi
    exit 0
fi

if [ "$command" = "resume" ]; then
    shift
    session_id=$1
    if [ -z "$session_id" ]; then
        session_id=$(ls -1t "$SESSIONS_DIR" 2>/dev/null | grep -v "latest" | head -n 1)
        if [ -z "$session_id" ]; then
            echo "No sessions found to resume."
            exit 1
        fi
        echo "Resuming latest session: $session_id"
    fi
    session="$SESSIONS_DIR/$session_id"
    if [ ! -d "$session" ]; then
        echo "Session not found: $session_id"
        exit 1
    fi
    command=""
fi

if [ ! -z "$command" ]; then
    shift
    . $AISH_HOME/functions
    func_name="aish_${command}"
    $func_name $@
    exit $?
fi

# If no directory is specified, use a new timestamped one in SESSIONS_DIR
if [ -z "$session" ]; then
    mkdir -p "$SESSIONS_DIR"
    session_id=$(date +%Y%m%d_%H%M%S)
    session="$SESSIONS_DIR/$session_id"
    mkdir -p "$session"
    ln -sfT "$session_id" "$SESSIONS_DIR/latest"
    echo "Starting new session: $session_id"
else
    mkdir -p $session
fi

export AISH_SESSION="$session"
export AISH_PART="$AISH_SESSION/part"
export AISH_LOGFILE="$session/script.jsonl"

if [ ! -d "$AISH_PART" ]; then
  mkdir -p "$AISH_PART"
fi

[ -p "$AISH_SESSION/fifo" ] || { rm -f "$AISH_SESSION/fifo"; mkfifo "$AISH_SESSION/fifo"; }

# Determine if we should append to the log file
append_flag=""
if [ -f "$AISH_LOGFILE" ]; then
    append_flag="--append"
fi

# No command specified, start a new session
$AISH_CAPTURE_BIN $append_flag -o $AISH_LOGFILE --input-fifo $AISH_SESSION/fifo

# --- Self-Improvement Process ---
if [ -f "$AISH_LOGFILE" ]; then
    # バックグラウンドまたはメッセージを表示して実行
    echo "Self-improving based on session history..."
    (
        export AISH_HOME="$AISH_HOME"
        export AISH_SESSION="$AISH_SESSION"
        [ -f "$AISH_HOME/lib/self_improve.sh" ] && . "$AISH_HOME/lib/self_improve.sh"
        # 必要なライブラリ（ai.gpt または ai.gemini）を読み込む
        # 現在の設定からプロバイダを特定
        provider=$(cat "$AISH_HOME/task.d/agent/conf" 2>/dev/null | grep "provider" | cut -d'=' -f2 | tr -d '" ' || echo "gemini")
        [ -f "$AISH_HOME/ai.$provider" ] && . "$AISH_HOME/ai.$provider"
        
        run_self_improvement "$AISH_LOGFILE"
    ) > /dev/null 2>&1
fi
# --------------------------------

echo "end"
#rm -rf $session
