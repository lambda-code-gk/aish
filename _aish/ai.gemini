#!/usr/bin/env bash

set -eo pipefail

#MODEL="gemini-1.5-flash"
#MODEL="gemini-1.5-pro"
#MODEL="gemini-2.0-flash-exp"
#MODEL="gemini-2.0-flash"
#MODEL="gemini-2.5-pro-preview-03-25"
#MODEL="gemini-2.5-flash-preview-04-17"
#MODEL="gemini-2.5-pro-preview-05-06"
#MODEL="gemini-2.5-flash-preview-05-20"
#MODEL="gemini-2.5-flash-preview-05-20"
MODEL="gemini-3-flash-preview"

LOG="$AISH_SESSION"/log.json

# 共通ライブラリを読み込む
. "$AISH_HOME/lib/agent_approve.sh"
. "$AISH_HOME/lib/tool_execute_shell_command.sh"

function query
{
  system_instruction=""
  agent_mode=false
  while getopts "s:a" opt; do
    case $opt in
      s) system_instruction=$OPTARG ;;
      a) agent_mode=true ;;
      *)  ;;
    esac
  done
  shift $((OPTIND - 1))

  aish_rollout

  files=$(detail.aish_list_parts | detail.aish_security_check)
  if [ $? -ne 0 ]; then
      exit 1
  fi
  
  if [ "$agent_mode" = true ]; then
    echo -e "$files" | make_request_agent "$*" "$system_instruction" | send_to_llm_agent
  else
    echo -e "$files" | make_request "$*" "$system_instruction" | send_to_llm
  fi
}

function make_request
{
  query=$1
  system=$2

  echo '{'

  if [ ! -z "$system" ];
  then
    echo '"system_instruction": {"parts": {"text": '$(echo "$system" | json_string)'}},'
  fi


  echo '"contents":['

  while IFS= read -r file; do
    if [[ "$file" =~ "_user.txt" ]]; then
      role="user"
    else
      role="model"
    fi
    echo -n '  {"role": "'$role'", "parts":[{"text": '
    cat "$file" | json_string
    echo '}]},'
  done
  user_input=$(echo -e "----\n# user message:\n$query" | json_string)
  echo '  {"role": "user", "parts":[{"text": '"$user_input"'}]}'
  echo ']'
  echo '}'
}

function send_to_llm
{
  REQUEST_FILE="$AISH_SESSION/request.txt"
  cat > $REQUEST_FILE
  request_data=$(cat "$REQUEST_FILE")

  detail.aish_log_request "$request_data"

  response=$(curl -s https://generativelanguage.googleapis.com/v1beta/models/"$MODEL":generateContent?key="$GEMINI_API_KEY" \
    -H 'Content-Type: application/json' \
    -X POST \
    --data-binary @${REQUEST_FILE})

  detail.aish_log_response "$response"

  text="$(echo "$response" | jq -r '.candidates[0].content.parts[0].text')"

  if [ "$text" == "null" -o -z "$text" ];
  then
    echo "$response"
    exit 1
  fi

  echo "$text" | tee "$AISH_PART/part_$(date +%Y%m%d_%H%M%S)_assistant.txt"
  echo "$text" | detail.aish_pickup_codeblock
}

function make_request_agent
{
  query=$1
  system=$2

  echo '{'

  if [ ! -z "$system" ];
  then
    echo '"system_instruction": {"parts": {"text": '$(echo "$system" | json_string)'}},'
  fi

  echo '"tools": [{"functionDeclarations": [{"name": "execute_shell_command", "description": "Execute a shell command and return the result with exit code, stdout, and stderr", "parameters": {"type": "object", "properties": {"command": {"type": "string", "description": "The shell command to execute"}}, "required": ["command"]}}]}],'

  echo '"contents":['

  while IFS= read -r file; do
    if [[ "$file" =~ "_user.txt" ]]; then
      role="user"
    elif [[ "$file" =~ "_function.txt" ]]; then
      role="function"
    else
      role="model"
    fi
    
    # function roleの場合は特別な処理
    if [ "$role" = "function" ]; then
      # function response形式で出力
      echo -n '  {"role": "function", "parts":['
      cat "$file"
      echo ']},'
    else
      echo -n '  {"role": "'$role'", "parts":[{"text": '
      cat "$file" | json_string
      echo '}]},'
    fi
  done
  user_input=$(echo -e "----\n# user message:\n$query" | json_string)
  echo '  {"role": "user", "parts":[{"text": '"$user_input"'}]}'
  echo ']'
  echo '}'
}

function send_to_llm_agent
{
  REQUEST_FILE="$AISH_SESSION/request.txt"
  MAX_ITERATIONS=20
  iteration=0
  
  # 初期リクエストを保存
  cat > $REQUEST_FILE
  
  while [ $iteration -lt $MAX_ITERATIONS ]; do
    iteration=$((iteration + 1))
    request_data=$(cat "$REQUEST_FILE")

    detail.aish_log_request "$request_data"

    response=$(curl -s https://generativelanguage.googleapis.com/v1beta/models/"$MODEL":generateContent?key="$GEMINI_API_KEY" \
      -H 'Content-Type: application/json' \
      -X POST \
      --data-binary @${REQUEST_FILE})
    
    curl_exit_code=$?
    if [ $curl_exit_code -ne 0 ]; then
      echo "$response" >&2
      exit 1
    fi

    detail.aish_log_response "$response"

    # エラーチェック
    error=$(echo "$response" | jq -r '.error.message // empty' 2>/dev/null)
    if [ ! -z "$error" ]; then
      echo "$response" >&2
      exit 1
    fi

    # functionCallsをチェック
    has_function_calls=$(echo "$response" | jq -e '.candidates[0].content.parts[] | select(.functionCall != null)' > /dev/null 2>&1 && echo "yes" || echo "no")
    
    if [ "$has_function_calls" = "yes" ]; then
      # function callがある場合、各function callを処理
      temp_request="$AISH_SESSION/temp_request_$$.json"
      
      # モデルの応答（function callを含む）をcontentsに追加
      model_parts=$(echo "$response" | jq -c '.candidates[0].content.parts')
      if [ -z "$model_parts" ] || [ "$model_parts" = "null" ]; then
        echo "$response" >&2
        exit 1
      fi
      
      updated_request=$(echo "$request_data" | jq --argjson model_parts "$model_parts" \
        '.contents += [{"role": "model", "parts": $model_parts}]')
      
      if [ $? -ne 0 ]; then
        exit 1
      fi
      
      # 各function callを処理してfunction responseを収集
      func_responses_file="$AISH_SESSION/func_responses_$$.json"
      echo "[]" > "$func_responses_file"
      
      # function callのリストを一時ファイルに保存
      func_calls_file="$AISH_SESSION/func_calls_$$.json"
      echo "$response" | jq -c '.candidates[0].content.parts[] | select(.functionCall != null) | .functionCall' > "$func_calls_file"
      
      # 各function callを処理
      while IFS= read -r func_call; do
        if [ -z "$func_call" ]; then
          continue
        fi
        func_name=$(echo "$func_call" | jq -r '.name')
        func_args=$(echo "$func_call" | jq -r '.args')
        
        if [ "$func_name" = "execute_shell_command" ]; then
          command=$(echo "$func_args" | jq -r '.command')
          
          # シェルコマンドを実行
          result=$(execute_shell_command "$command")
          
          # function responseを生成
          func_response=$(echo "$result" | jq -c '{functionResponse: {name: "execute_shell_command", response: .}}')
          if [ $? -ne 0 ]; then
            exit 1
          fi
          
          # 配列に追加
          echo "$(cat "$func_responses_file")" | jq --argjson func_res "$func_response" '. += [$func_res]' > "${func_responses_file}.new"
          if [ $? -ne 0 ]; then
            exit 1
          fi
          mv "${func_responses_file}.new" "$func_responses_file"
        fi
      done < "$func_calls_file"
      
      # すべてのfunction responseをcontentsに追加
      func_responses=$(cat "$func_responses_file")
      echo "$updated_request" | jq --argjson func_responses "$func_responses" \
        '.contents += ($func_responses | map({"role": "function", "parts": [.]}))' > "$temp_request"
      
      if [ $? -ne 0 ]; then
        exit 1
      fi
      
      mv "$temp_request" "$REQUEST_FILE"
      rm -f "$func_responses_file" "$func_calls_file"
      
      # 次のイテレーションに進む
      continue
    else
      # function callがない場合、テキスト応答を返して終了
      # すべてのテキストパートを結合
      text="$(echo "$response" | jq -r '[.candidates[0].content.parts[]? | select(.text != null) | .text] | join("")')"
      
      if [ "$text" == "null" -o -z "$text" ]; then
        echo "$response" >&2
        exit 1
      fi

      echo "$text" | tee "$AISH_PART/part_$(date +%Y%m%d_%H%M%S)_assistant.txt"
      echo "$text" | detail.aish_pickup_codeblock
      return 0
    fi
  done
  
  echo "Error: Maximum iterations ($MAX_ITERATIONS) reached" >&2
  exit 1
}
