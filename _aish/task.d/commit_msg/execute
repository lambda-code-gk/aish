#!/usr/bin/bash

message_file=$AISH_SESSION/messages.txt

make_message $message_file "これから提供するログと変更点を読んで下さい"
#send_request $message_file
echo ----
echo "# log"
git --no-pager log -n 5
echo ----
echo "# diff"
git --no-pager diff --cached
echo ----
prev_codeblock_count=$(ls $AISH_SESSION/codeblock_* | wc -l)
make_message $message_file "上記のdiffから意図を抽出しコミットメッセージを書いて下さい。"
send_request $message_file
codeblock_count=$(ls $AISH_SESSION/codeblock_* | wc -l)
if [ $codeblock_count -gt $prev_codeblock_count ];
  ai_generated_message=$(ls $AISH_SESSION/part_*_assistant.txt | tail -n 1)
  commit_message_file=$AISH_SESSION/commit_message.txt
then
  ai_generated_message=$(ls $AISH_SESSION/codeblock_* | tail -n 1)
  commit_message_file=$AISH_SESSION/commit_message.txt
fi
echo "This is an auto-generated commit message" > $commit_message_file
echo "If you want to commit, please delete this comment" >> $commit_message_file
echo "####" >> $commit_message_file
cat $ai_generated_message >> $commit_message_file
echo "commit message: $commit_message_file"
git commit --template=$commit_message_file
