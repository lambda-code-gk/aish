#!/usr/bin/env bash

# 既定のbash設定を読み込んで、色付きプロンプトやエイリアスを有効にする
if [ -f /etc/bash.bashrc ]; then
    . /etc/bash.bashrc
fi

if [ -f "$HOME/.bashrc" ]; then
    . "$HOME/.bashrc"
fi

# AISH_HOME を指定した場合のみ PATH に bin を追加（ポータブル/インストール用）
if [ -n "$AISH_HOME" ]; then
    export PATH=$PATH":$AISH_HOME/bin"
fi

# partファイルサイズを計算して表示用の文字列を返す
__aish_calc_part_size() {
    # セッションが無い場合
    if [ -z "$AISH_SESSION" ]; then
        echo -n "---"
        return
    fi

    # ミュート中はサイズを表示しない
    # Rust 実装側では session_dir/console.muted をフラグとして使用する
    if [ -f "$AISH_SESSION/console.muted" ]; then
        echo -n "---"
        return
    fi

    # partファイルが無い場合
    local parts
    parts=$(ls "$AISH_SESSION"/part_* 2>/dev/null || true)
    if [ -z "$parts" ]; then
        echo -n "0B"
        return
    fi

    # du --apparent-size -ch の total 行だけを取り出して末尾の " total" を削る
    env LANG=C du --apparent-size -ch $parts 2>/dev/null | \
        grep 'total$' | sed -e 's/[ \t]\+total$//'
}

# コマンド終了時に自動でpartファイルを作成しつつ、プロンプトにサイズを表示
if [ -n "$AISH_PID" ]; then
    # 元のPS1を保存（多重定義を避ける）
    if [ -z "$AISH_PS1_ORG" ]; then
        export AISH_PS1_ORG="$PS1"
    fi

    # 既存のPROMPT_COMMANDを保持しつつ、SIGUSR1送信とPS1更新を行う。
    # PS1 末尾には PromptReady マーカー（OSC 999, BEL 終端）を埋め込む。
    if [ -n "$PROMPT_COMMAND" ]; then
        export PROMPT_COMMAND="kill -usr1 $AISH_PID 2>/dev/null; PS1=\"(aish:\$(__aish_calc_part_size))$AISH_PS1_ORG\\[\\e]999;aish-prompt-ready\\a\\]\"; $PROMPT_COMMAND"
    else
        export PROMPT_COMMAND="kill -usr1 $AISH_PID 2>/dev/null; PS1=\"(aish:\$(__aish_calc_part_size))$AISH_PS1_ORG\\[\\e]999;aish-prompt-ready\\a\\]\""
    fi
fi

# zshの場合（PROMPT にも PromptReady マーカーを埋め込む）
if [ -n "$AISH_PID" ] && [ -n "$ZSH_VERSION" ]; then
    precmd() {
        kill -usr1 $AISH_PID 2>/dev/null
    }
    PROMPT="(aish:\$(__aish_calc_part_size))$PROMPT%{\e]999;aish-prompt-ready\a%}"
fi

# Ctrl+L: 画面クリア + aish clear（partファイル削除）
__aish_ctrl_l() {
    clear
    aish clear 2>/dev/null
}
bind -x '"\C-l": __aish_ctrl_l'

# Tab補完: aish / ai（コマンドがある場合のみ有効化）
if command -v aish >/dev/null 2>&1; then
    source <(aish --generate bash 2>/dev/null) || true
fi
if command -v ai >/dev/null 2>&1; then
    source <(ai --generate bash 2>/dev/null) || true
fi
