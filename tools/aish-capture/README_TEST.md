# aish-capture テストガイド

## 概要

`test.sh` は `aish-capture` コマンドの動作を確認するための自動化テストスクリプトです。

## 実行方法

### 基本的な実行（対話的ターミナル）

```bash
cd aish-capture
cargo build --release  # まずビルド
./test.sh
```

### カスタムバイナリパスを指定

```bash
BINARY=./target/debug/aish-capture ./test.sh
```

### 非対話的環境での実行

非対話的な環境（CI環境など）では、PTYが必要なテストは自動的にスキップされます：

```bash
# エラー終了コードのテストのみ実行される
./test.sh
```

対話的な環境をシミュレートするには：

```bash
# scriptコマンドを使用
script -c './test.sh' /dev/null

# または expect を使用（expectが必要）
expect -c 'spawn ./test.sh; interact'
```

## テストケース

### 1. コマンド実行テスト
- `echo` コマンドを実行し、出力が正しくキャプチャされることを確認
- JSONLファイルに `start`, `stdout`, `exit` イベントが記録されることを確認
- `data`フィールドが正しく記録されることを確認（テキストの場合は直接、バイナリの場合はbase64エンコード）

### 2. 終了コード伝播テスト
- 子プロセスの終了コードが正しく伝播されることを確認
- JSONLの `exit` イベントに終了コードが正しく記録されることを確認

### 3. --no-stdin オプションテスト
- `--no-stdin` オプションが正しく機能することを確認
- JSONLに `stdin` イベントが記録されないことを確認

### 4. --cwd オプションテスト
- `--cwd` オプションで作業ディレクトリが正しく設定されることを確認

### 5. --env オプションテスト
- `--env` オプションで環境変数が正しく設定されることを確認

### 6. エラー終了コードテスト
- 不正なオプションが指定された場合、適切な終了コード（64）が返されることを確認

### 7. JSONL形式検証テスト
- JSONLファイルの各行が有効なJSONであることを確認
- 各イベントタイプに必要なフィールドが含まれていることを確認

### 8. --append オプションテスト
- `--append` オプションで既存のファイルに追記されることを確認

## 手動テスト（自動化できないテスト）

以下のテストは対話的な操作が必要なため、手動で実行してください。

### 対話シェル記録

```bash
./target/release/aish-capture -o /tmp/test.jsonl
# 対話的にコマンドを実行し、exit で戻る
# JSONL に start/stdout/exit が記録されていることを確認
```

### リサイズテスト

```bash
./target/release/aish-capture -o /tmp/test.jsonl
# 実行中にターミナルウィンドウのサイズを変更
# JSONL に resize イベントが記録されていることを確認
```

### full-screen系アプリケーション

```bash
./target/release/aish-capture -o /tmp/test.jsonl
# vim, less, top などを起動
# 致命的な問題が発生しないことを確認
```

## トラブルシューティング

### TTYが必要なテストが失敗する場合

`aish-capture`はPTY（疑似ターミナル）を使用するため、対話的なターミナル（TTY）が必要です。非対話的な環境（CI環境など）で実行する場合、PTYベースのテストは自動的にスキップされます。

対話的なターミナルで実行するには：

```bash
# scriptコマンドを使用
script -c './test.sh'

# または単にターミナルから直接実行
./test.sh
```

CI環境で実行する場合は、`expect`や`socat`を使用してPTYを提供するか、PTYを使用しないテストのみを実行してください。

### バイナリが見つからない場合

まず、バイナリをビルドしてください：

```bash
cargo build --release
```

### テストの詳細な出力を見る

テストスクリプトは各テストの出力を一時ディレクトリに保存します。テストが失敗した場合、該当するファイルを確認してください：

```bash
# テストディレクトリは自動的に削除されますが、
# スクリプトの trap を無効にして手動で確認できます
```

## 継続的インテグレーション（CI）

CI環境で実行する場合、以下の点に注意してください：

1. TTYが必要なテストはスキップまたはモックする
2. バイナリを事前にビルドする
3. 環境変数 `BINARY` でバイナリのパスを明示的に指定する

## 開発時の活用

開発中は以下のようにして、特定のテストのみを実行できます：

```bash
# test.sh を編集して、実行したいテストのみを残す
# または、test_case 関数を直接呼び出す
source test.sh
test_command_execution
```

